<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>HANSEL - {{ context.title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='web/css/viewer_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='web/css/rich_content_style.css') }}">
    {% if context.verse_only %}
    <link rel="stylesheet" href="{{ url_for('static', filename='web/css/rich_verse_style.css') }}">
    {% endif %}
</head>
<body class="{% if context.verse_only %}simple-verse-style{% endif %}">
    <a href="/" id="home-button">
        <img src="{{ url_for('static', filename='web/imgs/logo_cute_1.png') }}" alt="Home">
    </a>
    <div id="toggles-widget-icon">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <div id="toggles-widget" class="toggles-widget-container panel">
        <div id="toggles-widget-close-button">&times;</div>

        {% if not context.verse_only %}
        <div class="toggle-switch-container">
            <label class="toggle-switch">
                <input type="checkbox" onchange="toggleLocationMarkers(this)">
                <span class="toggle-switch-text">Locations</span>
                <span class="toggle-switch-handle"></span>
            </label>
        </div>

        <div class="toggle-switch-container rich-text-toggle">
            <label class="switch">
                <input type="checkbox" onchange="toggleLineBreaks(this)">
                <span class="toggle-switch-text switch-text-off">Paragraphs</span>
                <span class="toggle-switch-text switch-text-on">Lines</span>
            </label>
        </div>
        {% endif %}

        <div class="toggle-switch-container rich-text-toggle">
            <label class="toggle-switch">
                <input type="checkbox" onchange="toggleBreaks(this)">
                <span class="toggle-switch-text">{{ "Page breaks" if context.verse_only else "Line/Page breaks" }}</span>
                <span class="toggle-switch-handle"></span>
            </label>
        </div>

        <div class="toggle-switch-container rich-text-toggle">
            <label class="toggle-switch">
                <input type="checkbox" onchange="toggleCorrections(this)">
                <span class="toggle-switch-text">Corrections</span>
                <span class="toggle-switch-handle"></span>
            </label>
            <img id="corrections-info-icon"
                 class="info-icon"
                 src="{{ url_for('static', filename='web/imgs/info.png') }}"
                 title="Toggles display of corrections, listed at the bottom of the metadata panel.">
        </div>

        <div class="toggle-switch-container">
            <label class="toggle-switch">
                <input type="checkbox" onchange="toggleViewMode(this)">
                <span class="toggle-switch-text">Search-friendly</span>
                <span class="toggle-switch-handle"></span>
            </label>
        </div>

        <div class="toggle-switch-container">
            <div id="transliteration-controls-container">
                <span class="toggle-switch-text">ā→आ</span>
                <div id="transliteration-controls">
                    <select id="transliteration-scheme"></select>
                    <label id="toggle-switch-text">
                        <input type="checkbox" id="show-all-schemes-checkbox">
                        <span class="toggle-switch-text"> more</span>
                    </label>
                </div>
            </div>
        </div>

        {% if context.verse_only %}
        <div class="toggle-switch-container">
            <label class="toggle-switch">
                <input type="checkbox" onchange="toggleVerseFormatting(this)">
                <span class="toggle-switch-text">Verse Styling</span>
                <span class="toggle-switch-handle"></span>
            </label>
        </div>

        <div class="toggle-switch-container verse-format-toggle">
            <label class="simple-checkbox-label">Verse Spacing</label>
            <input id="width-slider" type="range" min="0" max="1.6" step="0.4" value="0.8">
        </div>
        {% endif %}
    </div>

    <div id="border-widgets">
        <div id="metadata-widget-container">
            <button id="metadata-button">Metadata</button>
        </div>

        <div id="toc-widget-container">
            <button id="toc-button">Table of Contents</button>
        </div>
    </div>

    <div id="metadata-panel" class="panel">
        <ul id="metadata-list">
            {% if context.metadata_entries %}
                {% for entry in context.metadata_entries %}
                    {% if entry.type == 'field' %}
                        {% set inline_text = entry.inline_text | default('', true) | trim %}
                        {% set html_fragment = entry.content_html | default('', true) %}
                        {% set html_text = html_fragment | striptags | replace('&nbsp;', '') | trim %}
                        {% set has_inline = inline_text != '' %}
                        {% set has_html = html_text != '' %}
                        {% if entry.label %}
                            <li>
                                {% if entry.label %}
                                    <b>{{ entry.label }}{% if has_inline or has_html %}: {% endif %}</b>
                                {% endif %}
                                {% if has_inline %}
                                    {{ inline_text }}
                                {% endif %}
                                {% if has_html %}
                                    {{ html_fragment | safe }}
                                {% endif %}
                            </li>
                        {% endif %}
                    {% elif entry.type == 'corrections' %}
                        <li id="corrections-list-container">
                            <b>Corrections ({{ entry.count }}) <span class="caret">▶</span></b>
                            <table style="display: none; padding-left: 2em;">
                                <tbody>
                                    {% for item in entry.rows %}
                                    <tr>
                                        <td style="padding-right: 1em;">p.{{ item.page }}, l.{{ item.line }}:</td>
                                        <td>
                                            {% if item.sic == '' and item.corr == ' ' %}
                                                space added
                                            {% elif item.sic == ' ' and item.corr == '' %}
                                                space removed
                                            {% elif item.corr == '' and item.sic != '' %}
                                                {{ item.sic }} deleted
                                            {% elif item.sic == '' and item.corr != '' %}
                                                {{ item.corr }} added
                                            {% else %}
                                                {{ item.sic }} → {{ item.corr }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </li>
                    {% endif %}
                {% endfor %}
            {% else %}
                <li>No metadata available.</li>
            {% endif %}
        </ul>
    </div>

    <div id="toc-panel" class="panel">
        <ul id="toc-list">
            {% for item in context.toc %}
            <li>
                <a href="#{{ item.id }}">§ {{ item.name }} (p.{{ item.page }})</a>
            </li>
            {% endfor %}
        </ul>
    </div>

    {{ content_html | safe }}

    <script src="https://cdn.jsdelivr.net/npm/@indic-transliteration/sanscript/sanscript.min.js"></script>
    <script src="{{ url_for('static', filename='web/js/rich_script.js') }}"></script>
    {% if context.verse_only %}
    <script src="{{ url_for('static', filename='web/js/rich_verse_script.js') }}"></script>
    {% endif %}

    {% if context.pdf_page_mapping %}
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const mapping = {{ context.pdf_page_mapping | tojson | safe }};
        if (mapping && mapping.url && mapping.offsets) {
            const url = mapping.url;
            const offsets = mapping.offsets.sort((a, b) => a[0] - b[0]); // sort by edition page

            const pageLabels = document.querySelectorAll('a.pb-label');

            let pageNumberRegex;

            // Simple regexes for known URL patterns
            const archiveOrgRegex = /(.*\/page\/n)(\d+)(\/mode\/.*)/;
            const googleBooksRegex = /(.*&pg=GBS\.PP)(\d+)(.*)/;
            const hathiTrustRegex = /(.*&seq=)(\d+)(.*)/;

            if (archiveOrgRegex.test(url)) {
                pageNumberRegex = archiveOrgRegex;
            } else if (googleBooksRegex.test(url)) {
                pageNumberRegex = googleBooksRegex;
            } else if (hathiTrustRegex.test(url)) {
                pageNumberRegex = hathiTrustRegex;
            }

            // Fallback: try to find a number at the end of the URL or in a page= param
            if (!pageNumberRegex) {
                // case: page=123
                if (/[?&]page=\d+/.test(url)) {
                    pageNumberRegex = /(.*[?&]page=)(\d+)(.*)/;
                }
                // case: /page/123
                else if (/\/page\/\d+/.test(url)) {
                    pageNumberRegex = /(.*\/page\/)(\d+)(.*)/;
                }
                 // case: ends with a number
                else if (/\d+$/.test(url)) {
                    pageNumberRegex = /^(.*?)(\d+)$/;
                }
            }

            pageLabels.forEach(label => {
                const editionPageStr = label.dataset.page;
                if (!editionPageStr) return;
                
                const editionPage = parseInt(editionPageStr, 10);
                if (isNaN(editionPage)) return;

                // Find the correct offset rule
                let applicableOffset = [0, 0]; // default to no offset
                for (const offset of offsets) {
                    if (offset[0] <= editionPage) {
                        applicableOffset = offset;
                    } else {
                        break; // since offsets is sorted
                    }
                }
                
                const offsetDelta = applicableOffset[1] - applicableOffset[0];
                const pdfPage = editionPage + offsetDelta;

                if (pageNumberRegex) {
                    const finalUrl = url.replace(pageNumberRegex, `$1${pdfPage}$3`);
                    label.href = finalUrl;
                } else {
                    label.href = url; // fallback
                }
            });
        }
    });
    </script>
    {% endif %}
</body>
</html>
