<!DOCTYPE html>
<html lang="en">
<head>
    {% include 'components/head_shared.html' %}
    <title>HANSEL - E-Texts</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="{{ url_for('static', filename='web/js/sort.js') }}"></script>
</head>
<body>
<div id="content">
    {% from 'components/sidenav.html' import sidenav %}
    {% set nav_links = [
        {'url': '#e-texts', 'text': 'E-Texts'},
        {'url': '#cumulative-data', 'text': 'Downloads'},
        {'url': '/about', 'text': 'About'}
    ] %}
    {{ sidenav(nav_links) }}

    <div class="main">
        <div id="introduction">
            <p>
                <span id="index-title" style="font-size: 1.5em;">HANSEL</span>
                is an open collection of high-quality Sanskrit e-texts.
                <br>
                Get started with <a href="/getting_started">these videos</a>.
            </p>
        </div>

        <div id="e-texts">
            <div class="view-toggle">
                <h1 style="padding-right: 20px;">E-Texts</h1>
                <div class="toggle-switch-container">
                    <label class="switch">
                        <input type="checkbox" id="view-toggle-checkbox">
                        <span class="switch-text-off">List</span>
                        <span class="switch-text-on">Table</span>
                    </label>
                </div>
            </div>

            <div id="list-view">
                <p><em>Arrows&nbsp;<span class="toggle-caret" style="pointer-events: none;"></span>&nbsp;&nbsp;&nbsp;expand for more info.</em>&nbsp;&nbsp;<a href="#" id="expand-all-link">Expand All</a></p>
                <ul>
                    {% for item in metadata %}
                    <li class="file-item">
                        <div class="link-and-caret">
                            {% set html_filename = item['Filename Base'] ~ '.html' %}
                            <a href="{{ static_files_path }}/data/texts/transforms/html/rich/{{ html_filename }}" class="main-link">
                                {{ item['Title'] ~ (' - ' ~ item['Author'] if item['Author'] else '') }}
                            </a>
                            <details class="caret-details">
                                <summary class="toggle-caret"></summary>
                            </details>
                        </div>
                        <ul class="extra-links">
                            {% if item['PDFLinks'] %}
                            <li>
                                Based on:
                                <a href="{{ item['PDFLinks'][0]['url'] }}" target="_blank">
                                    {{ item['Edition'] }}
                                </a>
                            </li>
                            {% endif %}
                            <li>
                                <a href="{{ static_files_path }}/data/metadata/transforms/html/{{ item['Filename Base'] }}.html">
                                    <img src="{{ static_files_path }}/web/imgs/info.png" alt="metadata" style="height: 20px; margin-right: 2px;">
                                    Full Metadata
                                </a>
                            </li>
                            {% if item['Panditya URL'] %}
                            <li>
                                <a href="{{ item['Panditya URL'] }}" target="_blank" class="icon-link">
                                    <img src="{{ static_files_path }}/web/imgs/panditya.png" alt="Panditya" style="height: 20px; margin-left: -2px; margin-right: 4px;">
                                    View on Pāṇḍitya
                                </a>
                            </li>
                            {% endif %}
                            <li>
                                <div style="display: flex; align-items: center;">
                                    <img src="{{ static_files_path }}/web/imgs/dl.png" alt="download" style="height: 20px; margin-left: 4px; margin-right: 3px;">
                                    <span>Downloads</span>
                                </div>
                            </li>
                                <ul style="padding-left: 24px; margin-top: 5px;">
                                    <li>
                                        {% set original_filename_ext = item['Original Filename Extension'] %}
                                        {% set original_filename = item['Filename Base'] ~ original_filename_ext %}
                                        <a href="{{ static_files_path }}/data/texts/originals/{{ original_filename }}" class="main-link">
                                            {% if original_filename_ext == '.doc' %}
                                                <img src="{{ static_files_path }}/web/imgs/doc.png" alt="doc" style="height: 20px; margin-right: 2px;">
                                            {% elif original_filename_ext == '.xml' %}
                                                <img src="{{ static_files_path }}/web/imgs/xml.png" alt="xml" style="height: 20px; margin-right: 2px;">
                                            {% elif original_filename_ext == '.txt' %}
                                                <img src="{{ static_files_path }}/web/imgs/txt.png" alt="txt" style="height: 20px; margin-right: 2px;">
                                            {% else %}
                                                <img src="{{ static_files_path }}/web/imgs/dl.png" alt="download" style="height: 20px; margin-right: 2px;">
                                            {% endif %}
                                            Original file ({{ original_filename_ext }})
                                        </a>
                                    </li>
                                    <li>
                                        {% set txt_filename = item['Filename Base'] ~ '.txt' %}
                                        <a href="{{ static_files_path }}/data/texts/processed_txt/{{ txt_filename }}" class="main-link">
                                            <img src="{{ static_files_path }}/web/imgs/txt.png" alt="txt" style="height: 20px; margin-right: 2px;">
                                            Processed plain-text (<code>.txt</code>)
                                        </a>
                                    </li>
                                    <li>
                                        {% set xml_filename = item['Filename Base'] ~ '.xml' %}
                                        <a href="{{ static_files_path }}/data/texts/transforms/xml/{{ xml_filename }}" class="main-link">
                                            <img src="{{ static_files_path }}/web/imgs/xml.png" alt="xml" style="height: 20px; margin-right: 2px;">
                                            XML (<code>.xml</code>)
                                        </a>
                                    </li>
                                    <li>
                                        {% set html_filename = item['Filename Base'] ~ '.html' %}
                                        <a href="{{ static_files_path }}/data/texts/transforms/html/plain/{{ html_filename }}" class="main-link">
                                            <img src="{{ static_files_path }}/web/imgs/html.png" alt="html" style="height: 20px; margin-right: 2px;">
                                            Plain HTML (<code>.html</code>)
                                        </a>
                                    </li>
                                </ul>
                        </ul>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div id="table-view" style="display: none;">
                <table id="text_table" class="display" style="width:100%">
                  <thead>
                    <tr>
                      {% for field in display_fields %}
                        <th>{{ field }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
            </div>
        </div>

        <div id="cumulative-data">
            <h1>Cumulative Downloads</h1>
            <ul>
                <li class="file-item">
                    <div class="link-and-caret">
                        <a href="{{ static_files_path }}/data/texts/transforms/cumulative/txt.zip">
                            All plaintext (<code>.zip</code> of <code>.txt</code>)
                            <img src="{{ static_files_path }}/web/imgs/dl.png" alt="download" title="download" style="height: 25px; margin-bottom: -5px;">
                        </a>
                        <details class="caret-details">
                            <summary class="toggle-caret"></summary>
                        </details>
                    </div>
                    <ul class="extra-links">
                        <li>
                            <a href="{{ static_files_path }}/data/texts/transforms/cumulative/originals_misc.zip">
                                All originals (<code>.zip</code>&nbsp;of miscellaneous filetypes)
                                &nbsp;<img src="{{ static_files_path }}/web/imgs/dl.png" alt="download" title="download" style="height: 25px; margin-bottom: -5px;">
                            </a>
                        </li>
                        <li>
                            <a href="{{ static_files_path }}/data/texts/transforms/cumulative/xml.zip">
                                All XML (<code>.zip</code>&nbsp;of&nbsp;<code>.xml</code>)
                                &nbsp;<img src="{{ static_files_path }}/web/imgs/dl.png" alt="download" title="download" style="height: 25px; margin-bottom: -5px;">
                            </a>
                        </li>
                        <li>
                            <a href="{{ static_files_path }}/data/texts/transforms/cumulative/html_plain.zip">
                                All HTML, plain (<code>.zip</code>&nbsp;of&nbsp;<code>.html</code>)
                                &nbsp;<img src="{{ static_files_path }}/web/imgs/dl.png" alt="download" title="download" style="height: 25px; margin-bottom: -5px;">
                            </a>
                        </li>
                        <li>
                            <a href="{{ static_files_path }}/data/texts/transforms/cumulative/html_rich.zip">
                                All HTML, rich (<code>.zip</code>&nbsp;of&nbsp;<code>.html</code>)
                                &nbsp;<img src="{{ static_files_path }}/web/imgs/dl.png" alt="download" title="download" style="height: 25px; margin-bottom: -5px;">
                            </a>
                        </li>
                    </ul>
                </li>
                <li class="file-item">
                    <div class="link-and-caret">
                        <a href="{{ static_files_path }}/data/metadata/transforms/cumulative/metadata_md.zip">
                            All metadata (<code>.zip</code>&nbsp;of&nbsp;<code>.md</code>)
                            <img src="{{ static_files_path }}/web/imgs/dl.png" alt="download" title="download" style="height: 25px; margin-bottom: -5px;">
                        </a>
                        <details class="caret-details">
                            <summary class="toggle-caret"></summary>
                        </details>
                    </div>
                    <ul class="extra-links">
                        <li>
                            <a href="{{ static_files_path }}/data/metadata/transforms/cumulative/metadata_html.zip">
                                (<code>.zip</code>&nbsp;of&nbsp;<code>.html</code>)
                                &nbsp;<img src="{{ static_files_path }}/web/imgs/dl.png" alt="download" title="download" style="height: 25px; margin-bottom: -5px;">
                            </a>
                        </li>
                        <li>
                            <a href="{{ static_files_path }}/data/metadata/transforms/cumulative/metadata.json">
                                (single&nbsp;<code>.json</code>)
                            </a>
                        </li>
                    </ul>

                </li>
            </ul>
        </div>

        <br>

        <div id="more-info">

            <p><a href="about" class="main-link">About Page</a><p>

            <p>
                Email <strong><code>hanselrepository</code></strong> at Gmail with any questions, suggestions, or contributions
                (<code>.doc</code>, <code>.txt</code>, <code>.xml</code>, <code>.html</code>, <code>.pdf</code>, etc.)
            </p>

        </div>

    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const listView = document.getElementById('list-view');
    const tableView = document.getElementById('table-view');
    const viewToggle = document.getElementById('view-toggle-checkbox');

    let dataTable;

    function initializeDataTable() {
        $.fn.dataTable.ext.type.order['sanskrit-pre'] = d => {
          const txt = (d || '').replace(/<[^>]*>/g,'').toLowerCase().normalize('NFC');
          if (txt.trim() === '') return -Infinity; // blank cells get smallest possible key
          return saKey(txt);
        };
        $.fn.dataTable.ext.type.order['sanskrit-asc']  = (a, b) => a < b ? -1 : a > b ? 1 : 0;
        $.fn.dataTable.ext.type.order['sanskrit-desc'] = (a, b) => a < b ?  1 : a > b ? -1 : 0;

        const staticFilesPath = "{{ static_files_path }}";
        const tableData = {{ rows | tojson | safe }};   // full list of dicts

        function getOriginalFilenameWithExtension(row) {
          const base = row['Filename Base'];
          const ext = row['Original Filename Extension']
          return `${base}${ext}`;
        }

        dataTable = $('#text_table').DataTable({
          data: tableData,
          columnDefs: [
            {
              "targets": [5, 6, 7],  // Metadata, Panditya, download columns
              "orderable": false // Disable sorting
            }
          ],
          order: [[ 0, "asc" ]], // Sort by the 1st column (Title) in descending Sanskrit alphabetical order
          columns: [
            {
              data: 'Title',
              type: 'sanskrit',  // custom sort
              render: (data, type, row) => {
                if (type !== 'display') return data;   // keep raw text for sort/filter
                return `<a href="${staticFilesPath}/data/texts/transforms/html/rich/${row['Filename Base']}.html">${data}</a>`;
              }
            },
            { data: 'Author', type: 'sanskrit' },
                        { 
              data: 'Edition',
              render: function(data, type, row) {
                if (type === 'display' && row['PDFLinks'] && row['PDFLinks'].length > 0) {
                  return `<a href="${row['PDFLinks'][0]['url']}" target="_blank">${data}</a>`;
                }
                return data;
              }
            },
            { data: 'Genre', type: 'sanskrit' },
            { data: 'Size (kb)', className: 'text-end' },
            {
              data: 'Filename Base',
              render: function(data, type, row) {
                if (type !== 'display') return data;
                const href = `${staticFilesPath}/data/metadata/transforms/html/${row['Filename Base']}.html`;
                imgSrc = `${staticFilesPath}/web/imgs/info.png`;
                return (
                  `<a href="${href}" title="Full Metadata" class="icon-link">` +
                      `<img src="${imgSrc}" alt="metadata" style="height: 20px; margin-right: 2px;">` +
                  `</a>`
                )
              },
              createdCell: function(td) {
                td.style.textAlign = 'center';
              }
            },
            {
                data: 'Panditya URL',
                orderable: false,
                render: function(data, type, row) {
                    if (type === 'display' && data) {
                        const imgSrc = `${staticFilesPath}/web/imgs/panditya.png`;
                        return `<a href="${data}" target="_blank" title="View on Pāṇḍitya" class="icon-link"><img src="${imgSrc}" alt="Pāṇḍitya" style="height: 20px;"></a>`;
                    }
                    return '';
                },
                createdCell: function(td) {
                  td.style.textAlign = 'center';
                }
            },
            {
              data: 'Filename Base',
              render: function(data, type, row) {
                if (type !== 'display') return data;
                if (!data) return '';

                const txt_href = `${staticFilesPath}/data/texts/processed_txt/${row['Filename Base']}.txt`;
                const original_filename = getOriginalFilenameWithExtension(row);
                const original_href = `${staticFilesPath}/data/texts/originals/${original_filename}`;
                const original_ext = row['Original Filename Extension'];
                const xml_href = `${staticFilesPath}/data/texts/transforms/xml/${row['Filename Base']}.xml`;
                const html_href = `${staticFilesPath}/data/texts/transforms/html/plain/${row['Filename Base']}.html`;

                const imgSrc = `${staticFilesPath}/web/imgs/dl.png`;

                return `
                    <div class="dl-dropdown">
                        <button class="dl-dropdown-toggle icon-link">
                            <img src="${imgSrc}"
                            title="Downloads"
                            alt="Downloads" style="height: 20px;">
                        </button>
                        <div class="dl-dropdown-menu">
                            <a href="${original_href}">original file (${original_ext})</a>
                            <a href="${txt_href}">processed .txt</a>
                            <a href="${xml_href}">.xml transform </a>
                            <a href="${html_href}">plain .html transform </a>
                        </div>
                    </div>
                `;
              },
            }
          ],
          pageLength: 10
        });
    }

    viewToggle.addEventListener('change', function() {
        if (this.checked) {
            listView.style.display = 'none';
            tableView.style.display = 'block';
            if (!$.fn.DataTable.isDataTable('#text_table')) {
                initializeDataTable();
            }
        } else {
            listView.style.display = 'block';
            tableView.style.display = 'none';
        }
    });

    let allExpanded = false;
    const expandCollapseLink = document.getElementById('expand-all-link');

    if (expandCollapseLink) {
        expandCollapseLink.addEventListener('click', function(e) {
            e.preventDefault();
            const allFileItems = document.querySelectorAll('.file-item');

            if (allExpanded) {
                // Collapse all
                allFileItems.forEach(item => {
                    item.classList.remove('open');
                });
                expandCollapseLink.textContent = 'Expand All';
            } else {
                // Expand all
                allFileItems.forEach(item => {
                    item.classList.add('open');
                });
                expandCollapseLink.textContent = 'Collapse All';
            }
            allExpanded = !allExpanded;
        });
    }

    // dl-dropdown toggle
    document.addEventListener('click', function(event) {
        // Close all open dl-dropdowns that were not the one just clicked
        document.querySelectorAll('.dl-dropdown-menu.show').forEach(function(menu) {
            if (!menu.closest('.dl-dropdown').contains(event.target)) {
                menu.classList.remove('show');
            }
        });

        // Toggle the clicked dl-dropdown
        const dlDropdownToggle = event.target.closest('.dl-dropdown-toggle');
        if (dlDropdownToggle) {
            event.preventDefault();
            const dlDropdownMenu = dlDropdownToggle.nextElementSibling;
            if (dlDropdownMenu) {
                dlDropdownMenu.classList.toggle('show');
            }
        }
    });
});
</script>
<style>
    .view-toggle {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }
    .toggle-switch-container {
        margin-left: 1rem;
        width: 100px; /* Adjust width as needed */
    }
    .switch {
        position: relative;
        display: flex;
        width: 100%;
        height: 34px;
        background-color: #ccc;
        border-radius: 4px;
        overflow: hidden;
        cursor: pointer;
    }
    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
        position: absolute;
    }
    .switch-text-on, .switch-text-off {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        user-select: none;
        transition: all 0.2s;
    }
    .switch input:not(:checked) ~ .switch-text-off {
        background-color: #113121;
        color: white;
    }
    .switch input:not(:checked) ~ .switch-text-on {
        background-color: #ccc;
        color: #333;
    }
    .switch input:checked ~ .switch-text-on {
        background-color: #113121;
        color: white;
    }
    .switch input:checked ~ .switch-text-off {
        background-color: #ccc;
        color: #333;
    }
</style>
</body>
</html>
