<!DOCTYPE html>
<html lang="en">
<head>
    {% include 'components/head_shared.html' %}
    <title>HANSEL - E-Texts</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="{{ url_for('static', filename='web/js/sort.js') }}"></script>
</head>
<body>
<div id="content">
    {% from 'components/sidenav.html' import sidenav %}
    {% set nav_links = [
        {'url': '#e-texts', 'text': 'E-Texts'},
        {'url': '#cumulative-data', 'text': 'Downloads'},
        {'url': '/about', 'text': 'About'}
    ] %}
    {{ sidenav(nav_links) }}

    <div class="main">
        <div id="introduction">
            <p>
                <span id="index-title" style="font-size: 1.5em;">HANSEL</span>
                is an open collection of <a href="about#faq-gretil">new and newly modified</a> Sanskrit e-texts.
                <br class="hide-on-mobile-br">
                This website will help you to
                <a href="/getting_started#download">download</a>,
                <a href="/getting_started#read">read</a>, and
                <a href="/getting_started#contribute">contribute</a> texts.
            </p>
        </div>

        <div id="e-texts">
            <div class="view-toggle">
                <h1 style="padding-right: 20px;">E-Texts</h1>
                <div class="toggle-switch-container">
                    <label class="switch">
                        <input type="checkbox" id="view-toggle-checkbox">
                        <span class="switch-text-off">List</span>
                        <span class="switch-text-on">Table</span>
                    </label>
                </div>
            </div>

            <div id="list-view">
                <p style="padding-left: 10px;"><em>Arrows&nbsp;</em>(<span class="toggle-caret" style="pointer-events: none; padding: 0px;"></span>&nbsp;&nbsp;)&nbsp;<em>expand for more info.</em>&nbsp;&nbsp;<a href="#" id="expand-all-link">Expand All</a></p>
                {% set ext_map = {
                    '.txt': 'Plain-text',
                    '.doc': 'Word Doc',
                    '.docx': 'Word Doc',
                    '.xml': 'XML',
                    '.html': 'HTML',
                    '.md': 'Markdown'
                } %}
                <ul>
                    {% for item in metadata %}
                    <li class="file-item">
                        <div class="link-and-caret">
                            {% set html_filename = item['Filename Base'] ~ '.html' %}
                            <a href="{{ static_files_path }}/data/texts/transforms/html/rich/{{ html_filename }}" class="main-link">
                                {{ item['Title'] ~ (' - ' ~ item['Author'] if item['Author'] else '') }}
                            </a>
                            <details class="caret-details">
                                <summary class="toggle-caret"></summary>
                            </details>
                        </div>
                        <ul class="extra-links">
                            <li>
                                <a href="{{ static_files_path }}/data/metadata/transforms/html/{{ item['Filename Base'] }}.html">
                                    <img src="{{ static_files_path }}/web/imgs/info.png" alt="metadata" style="height: 20px; margin-left: -6px; margin-right: 8px;">
                                    Full Metadata - HTML
                                </a>
                            </li>
                            {% if item['PDFLinks'] %}
                            <li>
                                <a href="{{ item['PDFLinks'][0]['url'] }}" target="_blank">
                                    <img src="{{ static_files_path }}/web/imgs/edition.jpg" alt="metadata" style="height: 20px; margin-left: -4px; margin-right: 7px;">
                                    Edition (Printed): {{ item['Edition'] }}
                                </a>
                            </li>
                            {% endif %}
                            {% if item['Panditya URL'] %}
                            <li>
                                <a href="{{ item['Panditya URL'] }}" target="_blank" class="icon-link">
                                    <img src="{{ static_files_path }}/web/imgs/panditya.png" alt="Panditya" style="height: 20px; margin-left: -6px; margin-right: 9px;">
                                    View Network on Pāṇḍitya
                                </a>
                            </li>
                            {% endif %}
                            <li>
                                <div style="display: flex; align-items: center;">
                                    <img src="{{ static_files_path }}/web/imgs/dl.png" alt="download" style="height: 20px; margin-left: 3px; margin-right: 8px;">
                                    <span>Downloads</span>
                                </div>
                            </li>
                            <ul style="padding-left: 24px; margin-top: 5px;">
                                <li>
                                    {% set original_submission_filename_ext = item['Original Submission Filename Extension'] %}
                                    {% set readable_ext = ext_map.get(original_submission_filename_ext, original_submission_filename_ext) %}
                                    {% set original_submission_filename = item['Filename Base'] ~ original_submission_filename_ext %}
                                    <a href="{{ static_files_path }}/data/texts/original_submissions/{{ original_submission_filename }}" class="main-link">
                                        {% set ext = original_submission_filename_ext[1:] %}
                                        {% set icon = ext if ext in ['doc', 'xml', 'txt'] else 'dl' %}
                                        <img src="{{ static_files_path }}/web/imgs/{{ icon }}.png" alt="{{ 'download' if icon == 'dl' else icon }}" style="height: 20px; margin-left: -6px; margin-right: 8px;">
                                        Original Submission – {{ readable_ext }}
                                    </a>
                                </li>
                                <li>
                                    {% set txt_filename = item['Filename Base'] ~ '.txt' %}
                                    <a href="{{ static_files_path }}/data/texts/project_editions/txt/{{ txt_filename }}" class="main-link">
                                        <img src="{{ static_files_path }}/web/imgs/txt.png" alt="txt" style="height: 20px; margin-left: -6px; margin-right: 8px;">
                                        Project Digital Edition - Plain-text
                                    </a>
                                </li>
                                <li>
                                    {% set xml_filename = item['Filename Base'] ~ '.xml' %}
                                    <a href="{{ static_files_path }}/data/texts/project_editions/xml/{{ xml_filename }}" class="main-link">
                                        <img src="{{ static_files_path }}/web/imgs/xml.png" alt="xml" style="height: 20px; margin-left: -6px; margin-right: 8px;">
                                        Project Digital Edition - XML
                                    </a>
                                </li>
                                <li>
                                    {% set html_filename = item['Filename Base'] ~ '.html' %}
                                    <a href="{{ static_files_path }}/data/texts/transforms/html/plain/{{ html_filename }}" class="main-link">
                                        <img src="{{ static_files_path }}/web/imgs/html.png" alt="html" style="height: 20px; margin-left: -6px; margin-right: 8px;">
                                        Transform - Plain HTML
                                    </a>
                                </li>
                                <li>
                                    {% set md_filename = item['Filename Base'] ~ '.md' %}
                                    <a href="{{ static_files_path }}/data/metadata/markdown/{{ md_filename }}">
                                        <img src="{{ static_files_path }}/web/imgs/info.png" alt="metadata" style="height: 20px; margin-left: -6px; margin-right: 8px;">
                                        Full Metadata - Markdown
                                    </a>
                                </li>
                            </ul>
                        </ul>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div id="table-view" style="display: none;">
                <table id="text_table" class="display" style="width:100%">
                  <thead>
                    <tr>
                      {% for field in display_fields %}
                        <th>{{ field }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
            </div>
        </div>

        <hr style="border: none; border-top: 20px solid #013220; border-radius: 5px; margin: 20px 0;">

        <div id="cumulative-data">
            <h1>Cumulative Downloads</h1>
    
            <div class="file-item">
                <div class="link-and-caret">
                    <a href="/downloads/all" id="download-all-link">Download all files and metadata</a>
                    <img src="{{ static_files_path }}/web/imgs/dl.png" alt="download" class="download-icon">
                    <span class="size-estimate">({{ total_size_mb }} MB)</span>
                </div>
            </div>
    
            <hr style="border: none; border-top: 1px solid #ccc; margin: 1rem 0;">
    
            <div class="file-item" id="bundle-container">
                <div class="link-and-caret">
                    <a href="#" class="bundle-title">Build a custom bundle</a>
                    <details class="caret-details">
                        <summary class="toggle-caret"></summary>
                    </details>
                </div>
                <div class="extra-links" style="padding-left: 0;">
                    <form id="bundleForm" onsubmit="return false">
                        <fieldset>
                          <legend>Text format</legend>
                          <div class="radio-container"><input type="radio" id="text_none" name="text" value="none"><label for="text_none">None (metadata only)</label></div>
                          <div class="radio-container"><input type="radio" id="text_txt" name="text" value="txt" checked><label for="text_txt">Plain-text (.txt)</label></div>
                          <div class="radio-container"><input type="radio" id="text_xml" name="text" value="xml"><label for="text_xml">TEI-XML (.xml)</label></div>
                          <div class="radio-container"><input type="radio" id="text_html_plain" name="text" value="html_plain"><label for="text_html_plain">HTML — Plain</label></div>
                          <div class="radio-container"><input type="radio" id="text_html_rich" name="text" value="html_rich"><label for="text_html_rich">HTML — Rich</label></div>
                          <div class="radio-container"><input type="radio" id="text_original" name="text" value="original"><label for="text_original">Original Submission (misc. files)</label></div>
                        </fieldset>
    
                        <fieldset style="margin-top:0.75rem">
                          <legend>Metadata format</legend>
                          <div class="radio-container"><input type="radio" id="meta_md" name="meta" value="md" checked><label for="meta_md">Markdown (.md)</label></div>
                          <div class="radio-container"><input type="radio" id="meta_html" name="meta" value="html"><label for="meta_html">HTML (.html)</label></div>
                          <div class="radio-container"><input type="radio" id="meta_json" name="meta" value="json"><label for="meta_json">JSON (single file)</label></div>
                        </fieldset>
    
                        <button id="downloadBtn" type="button">Download</button>
                        <span id="bundle-size-container" style="display: none;">
                            <img src="{{ static_files_path }}/web/imgs/dl.png" alt="download" class="download-icon">
                            <span class="size-estimate" id="bundle-size-estimate"></span>
                        </span>
                    </form>
                </div>
            </div>
        </div>

        <br>

        <hr style="border: none; border-top: 20px solid #013220; border-radius: 5px; margin: 20px 0;">

        <div id="more-info">

            <p>
                See
                <a href="about" style="font-size: 1.2em;">About Page</a>
                to learn more.

            </p>

            <p>
                Visit
                <a href="contact" style="font-size: 1.2em;">Contact Page</a>
                to <strong>contribute</strong>! Also give feedback or ask questions.
            <p>

            </p>

        </div>

    </div>
</div>
<script>
const fileGroupSizes = {{ file_group_sizes | tojson | safe }};

// This script initializes the DataTable with server-side data from Jinja2 templates.
document.addEventListener('DOMContentLoaded', function() {
    const listView = document.getElementById('list-view');
    const tableView = document.getElementById('table-view');
    const viewToggle = document.getElementById('view-toggle-checkbox');

    let dataTable;

    function initializeDataTable() {
        $.fn.dataTable.ext.type.order['sanskrit-pre'] = d => {
          const txt = (d || '').replace(/<[^>]*>/g,'').toLowerCase().normalize('NFC');
          if (txt.trim() === '') return -Infinity; // blank cells get smallest possible key
          return saKey(txt);
        };
        $.fn.dataTable.ext.type.order['sanskrit-asc']  = (a, b) => a < b ? -1 : a > b ? 1 : 0;
        $.fn.dataTable.ext.type.order['sanskrit-desc'] = (a, b) => a < b ?  1 : a > b ? -1 : 0;

        const staticFilesPath = "{{ static_files_path }}";
        const tableData = {{ rows | tojson | safe }};   // full list of dicts
        const extMap = {{ ext_map | tojson | safe }};

        function getOriginalSubmissionFilenameWithExtension(row) {
          const base = row['Filename Base'];
          const ext = row['Original Submission Filename Extension']
          return `${base}${ext}`;
        }

        dataTable = $('#text_table').DataTable({
          data: tableData,
          columnDefs: [
            {
              "targets": [5, 6, 7],  // Metadata, Panditya, download columns
              "orderable": false // Disable sorting
            }
          ],
          order: [[ 0, "asc" ]], // Sort by the 1st column (Title) in descending Sanskrit alphabetical order
          columns: [
            {
              data: 'Title',
              type: 'sanskrit',  // custom sort
              render: (data, type, row) => {
                if (type !== 'display') return data;   // keep raw text for sort/filter
                return `<a href="${staticFilesPath}/data/texts/transforms/html/rich/${row['Filename Base']}.html">${data}</a>`;
              }
            },
            { data: 'Author', type: 'sanskrit' },
                        { 
              data: 'Edition',
              render: function(data, type, row) {
                if (type === 'display' && row['PDFLinks'] && row['PDFLinks'].length > 0) {
                  return `<a href="${row['PDFLinks'][0]['url']}" target="_blank">${data}</a>`;
                }
                return data;
              }
            },
            { data: 'Genre', type: 'sanskrit' },
            { data: 'Size (kb)', className: 'text-end' },
            {
              data: 'Filename Base',
              render: function(data, type, row) {
                if (type !== 'display') return data;
                const href = `${staticFilesPath}/data/metadata/transforms/html/${row['Filename Base']}.html`;
                imgSrc = `${staticFilesPath}/web/imgs/info.png`;
                return (
                  `<a href="${href}" title="Full Metadata" class="icon-link">` +
                      `<img src="${imgSrc}" alt="metadata" style="height: 20px; margin-right: 2px;">` +
                  `</a>`
                )
              },
              createdCell: function(td) {
                td.style.textAlign = 'center';
              }
            },
            {
                data: 'Panditya URL',
                orderable: false,
                render: function(data, type, row) {
                    if (type === 'display' && data) {
                        const imgSrc = `${staticFilesPath}/web/imgs/panditya.png`;
                        return `<a href="${data}" target="_blank" title="View on Pāṇḍitya" class="icon-link"><img src="${imgSrc}" alt="Pāṇḍitya" style="height: 20px;"></a>`;
                    }
                    return '';
                },
                createdCell: function(td) {
                  td.style.textAlign = 'center';
                }
            },
            {
              data: 'Filename Base',
              render: function(data, type, row) {
                if (type !== 'display') return data;
                if (!data) return '';

                const txt_href = `${staticFilesPath}/data/texts/project_editions/txt/${row['Filename Base']}.txt`;
                const original_submission_filename = getOriginalSubmissionFilenameWithExtension(row);
                const original_submission_href = `${staticFilesPath}/data/texts/original_submissions/${original_submission_filename}`;
                const original_submission_ext = row['Original Submission Filename Extension'];
                const readableExt = extMap[original_submission_ext] || original_submission_ext;
                const xml_href = `${staticFilesPath}/data/texts/project_editions/xml/${row['Filename Base']}.xml`;
                const html_href = `${staticFilesPath}/data/texts/transforms/html/plain/${row['Filename Base']}.html`;

                const imgSrc = `${staticFilesPath}/web/imgs/dl.png`;

                return `
                    <div class="dl-dropdown">
                        <button class="dl-dropdown-toggle icon-link">
                            <img src="${imgSrc}"
                            title="Downloads"
                            alt="Downloads" style="height: 20px;">
                        </button>
                        <div class="dl-dropdown-menu">
                            <a href="${original_submission_href}">original submission (${readableExt})</a>
                            <a href="${txt_href}">processed .txt</a>
                            <a href="${xml_href}">.xml transform </a>
                            <a href="${html_href}">plain .html transform </a>
                        </div>
                    </div>
                `;
              },
            }
          ],
          pageLength: 10
        });
    }

    if (viewToggle) {
        viewToggle.addEventListener('change', function() {
            if (this.checked) {
                listView.style.display = 'none';
                tableView.style.display = 'block';
                if (!$.fn.DataTable.isDataTable('#text_table')) {
                    initializeDataTable();
                }
            } else {
                listView.style.display = 'block';
                tableView.style.display = 'none';
            }
        });
    }
});
</script>
</body>
</html>