<!DOCTYPE html>
<html lang="en">
<head>
    {% include 'subtemplates/head_shared.html' %}
    <title>HANSEL - E-Texts (Table)</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="{{ url_for('static', filename='web/js/sort.js') }}"></script>
</head>
<body>
<div id="content">
    {% include 'subtemplates/sidenav_full.html' %}

    <div class="main">
        <div id="introduction">
            <h1>Introduction</h1>
            <p>
                HANSEL is an open collection of Sanskrit e-texts of all sorts.
                The current collection size is {{ num_items }} items ({{ total_size_mb }} mb in total).
            </p>
            <p>
                Below is a tabular presentation of the collection which you can search and sort.
                There's also a <a href="/">simple list view</a>.
            </p>
        </div>

        <div id="e-texts">
            <h1>E-Texts</h1>
            <table id="text_table" class="display" style="width:100%">
              <thead>
                <tr>
                  {% for field in display_fields %}
                    <th>{{ field }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>

        </div>

        {% include 'subtemplates/index_footer.html' %}

    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".toggle-caret").forEach(caret => {
        caret.addEventListener("click", function(event) {
            event.preventDefault(); // Prevent default summary behavior
            let li = this.closest(".file-item"); // Find the parent <li>
            li.classList.toggle("open"); // Toggle the 'open' class
        });
    });
});

$.fn.dataTable.ext.type.order['sanskrit-pre'] = d => {
  const txt = (d || '').replace(/<[^>]*>/g,'').toLowerCase().normalize('NFC');
  if (txt.trim() === '') return -Infinity; // blank cells get smallest possible key
  return saKey(txt);
};
$.fn.dataTable.ext.type.order['sanskrit-asc']  = (a, b) => a < b ? -1 : a > b ? 1 : 0;
$.fn.dataTable.ext.type.order['sanskrit-desc'] = (a, b) => a < b ?  1 : a > b ? -1 : 0;

const staticFilesPath = "{{ static_files_path }}";
const tableData = {{ rows | tojson | safe }};   // full list of dicts
console.log(tableData)

const medallionPathMap = {
  'bronze': '1_bronze',
  'silver': '2_silver',
  'gold': '3_gold'
};

function getFilenameWithExtension(medallion, row) {
  const base = row['Filename Base'];
  const ext = medallion.toLowerCase() === 'bronze'
    ? row['Bronze Filename Extension'] || '.txt'
    : '.txt'; // default for silver/gold, can be expanded later

  return `${base}${ext}`;
}

$('#text_table').DataTable({
  data: tableData,
  columns: [
    {
      data: 'Highest Medallion',
      render: function(data, type, row) {
        if (type !== 'display') return data;
        const medallion = data.toLowerCase();
        const imgSrc = `${staticFilesPath}/web/imgs/medallion_icons/${medallion}.png`;
        return `<img src="${imgSrc}" alt="${data}" title="${data}" style="height: 20px;">`;
        }
    },
    {
      data: 'Title',
      type: 'sanskrit',  // custom sort
      render: (data, type, row) => {
        if (type !== 'display') return data;   // keep raw text for sort/filter
        const highest_medallion = row['Highest Medallion']?.toLowerCase();
        const full_filename = getFilenameWithExtension(highest_medallion, row);
        const medallion_path = medallionPathMap[highest_medallion] || '1_bronze';
        return `<a href="${staticFilesPath}/data/texts/{medallion_path}/${full_filename}">${data}</a>`;
      }
    },
    { data: 'Author', type: 'sanskrit' },
    { data: 'Genre', type: 'sanskrit' },
    { data: 'Size (kb)', className: 'text-end' },
    {
      data: 'Other Versions',
      render: function(data, type, row) {
        if (type !== 'display') return data;
        if (!data) return '';

        return data
          .split(',')
          .map(medallion => {
            const highest_medallion_trimmed = medallion.trim();
            const highest_medallion_lower = highest_medallion_trimmed.toLowerCase();
            const medallion_path = medallionPathMap[highest_medallion_lower];
            const imgSrc = `${staticFilesPath}/web/imgs/medallion_icons/${highest_medallion_lower}.png`;
            const full_filename = getFilenameWithExtension(highest_medallion_lower, row);
            const href = `${staticFilesPath}/data/texts/${medallion_path}/${full_filename}`;

            return (
              `<a href="${href}" title="${highest_medallion_trimmed}">` +
                `<img src="${imgSrc}" alt="${highest_medallion_trimmed}" style="height: 20px; margin-right: 2px;">` +
              `</a>`
            );
          })
          .join('');
      },
      className: 'text-center'
    }
  ],
  pageLength: 25
});

</script>
</body>
</html>
