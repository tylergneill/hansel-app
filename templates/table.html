<!DOCTYPE html>
<html lang="en">
<head>
    {% include 'components/head_shared.html' %}
    <title>HANSEL - E-Texts (Table)</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="{{ url_for('static', filename='web/js/sort.js') }}"></script>
</head>
<body>
<div id="content">
    {% include 'components/sidenav_full.html' %}

    <div class="main">
        <div id="introduction">
            <h1>HANSEL</h1>
            <p>
                An open collection of high-quality Sanskrit e-texts of all sorts.
                Current collection size is {{ num_items }} items ({{ total_size_mb }} MB in total).
                See also <a href="/">list view</a>.
            </p>
        </div>

        <div id="e-texts">
            <h1>E-Texts</h1>
            <table id="text_table" class="display" style="width:100%">
              <thead>
                <tr>
                  {% for field in display_fields %}
                    <th>{{ field }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>

        </div>

        {% include 'components/index_footer.html' %}

    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".toggle-caret").forEach(caret => {
        caret.addEventListener("click", function(event) {
            event.preventDefault(); // Prevent default summary behavior
            let li = this.closest(".file-item"); // Find the parent <li>
            li.classList.toggle("open"); // Toggle the 'open' class
        });
    });
});

$.fn.dataTable.ext.type.order['sanskrit-pre'] = d => {
  const txt = (d || '').replace(/<[^>]*>/g,'').toLowerCase().normalize('NFC');
  if (txt.trim() === '') return -Infinity; // blank cells get smallest possible key
  return saKey(txt);
};
$.fn.dataTable.ext.type.order['sanskrit-asc']  = (a, b) => a < b ? -1 : a > b ? 1 : 0;
$.fn.dataTable.ext.type.order['sanskrit-desc'] = (a, b) => a < b ?  1 : a > b ? -1 : 0;

const staticFilesPath = "{{ static_files_path }}";
const tableData = {{ rows | tojson | safe }};   // full list of dicts
console.log(tableData)

function getFilenameWithExtension(tier, row) {
  const base = row['Filename Base'];
  const ext = tier.toLowerCase() === 'i'
    ? row['Tier I Filename Extension'] || '.txt'
    : '.txt'; // default for II/III, can be expanded later

  return `${base}${ext}`;
}

$('#text_table').DataTable({
  data: tableData,
  columnDefs: [
    {
      "targets": [1],  // Metadata column
      "orderable": false // Disable sorting
    }
  ],
  order: [[ 2, "asc" ]], // Sort by the 3th column (Title) in descending Sanskrit alphabetical order
  columns: [
    {
      data: 'Highest Tier',
      render: function(data, type, row) {
        if (type !== 'display') return data;
        const tier = data.toLowerCase();
        const imgSrc = `${staticFilesPath}/web/imgs/tier_icons/${tier}.png`;
        return `<img src="${imgSrc}" alt="${data}" title="${data}" style="height: 20px;">`;
        }
    },
    {
      data: 'Filename Base',
      render: function(data, type, row) {
        if (type !== 'display') return data;
        const href = `${staticFilesPath}/data/metadata/transforms/html/${row['Filename Base']}.html`;
        imgSrc = `${staticFilesPath}/web/imgs/info.png`;
        return (
          `<a href="${href}" title="metadata">` +
              `<img src="${imgSrc}" alt="metadata" style="height: 20px; margin-right: 2px;">` +
          `</a>`
        )
      },
      createdCell: function(td) {
        td.style.textAlign = 'center';
      }
    },
    {
      data: 'Title',
      type: 'sanskrit',  // custom sort
      render: (data, type, row) => {
        if (type !== 'display') return data;   // keep raw text for sort/filter
        const highest_tier = row['Highest Tier']?.toLowerCase();
        const full_filename = getFilenameWithExtension(highest_tier, row);
        const tier_path = highest_tier || 'I';
        return `<a href="${staticFilesPath}/data/texts/tier_${tier_path}/${full_filename}">${data}</a>`;
      }
    },
    { data: 'Author', type: 'sanskrit' },
    { data: 'Genre', type: 'sanskrit' },
    { data: 'Size (kb)', className: 'text-end' },
    {
      data: 'Other Tiers',
      render: function(data, type, row) {
        if (type !== 'display') return data;
        if (!data) return '';

        return data
          .split(',')
          .map(tier => {
            const highest_tier_trimmed = tier.trim();
            const highest_tier_lower = highest_tier_trimmed.toLowerCase();
            const tier_path = highest_tier_lower;
            const imgSrc = `${staticFilesPath}/web/imgs/tier_icons/${highest_tier_lower}.png`;
            const full_filename = getFilenameWithExtension(highest_tier_lower, row);
            const href = `${staticFilesPath}/data/texts/tier_${tier}/${full_filename}`;

            return (
              `<a href="${href}" title="${highest_tier_trimmed}">` +
                `<img src="${imgSrc}" alt="${highest_tier_trimmed}" style="height: 20px; margin-right: 2px;">` +
              `</a>`
            );
          })
          .join('');
      },
    }
  ],
  pageLength: 10
});

</script>
</body>
</html>
